.. _caching-policy:

4장. Caching 정책
******************

.. toctree::
   :maxdepth: 2



.. _caching-policy-ttl:

TTL (Time To Live)
====================================

.. _caching-policy-customttl:

Custom TTL
---------------------

URL마다 별도로 TTL을 설정한다.
명확한 URL 또는 패턴 URL에 매칭되는 콘텐츠마다 고정된 TTL을 설정할 수 있다.
/svc/{가상호스트 이름}/ttl.txt 에 설정한다. ::

    # /svc/www.example.com/ttl.txt
    # 구분자는 콤마(,)이며 시간 단위는 초이다.

    *.jsp, 10
    /,5
    /index.html, 5
    /script/*.js, 300
    /image/ad.jpg, 1800


모든 페이지(html, php, jsp 등)에 별도의 TTL을 설정하기 위하여 *.html을 추가하였더라도 첫 페이지(/)에는 설정되지 않는다.
원본서버가 첫 페이지를 어떤 페이지(예를 들어 index.php로 default.jsp 등)로 설정하였는지 HTTP 프로토콜로는 알 수 없다.
그러므로 모든 페이지에 별도의 TTL을 설정하려면 반드시 /를 추가해야 한다.

``CDN v2.6.13`` , ``Enterprise v19.07.0`` 부터 원본 응답코드에 따라 TTL을 지정할 수 있다. ::

    $URL[/image/ad.jpg], 1800
    $URL[*.jpg] & $ORGSTATUS[200], 3600
    $URL[/image/ad.jpg] & $ORGSTATUS[4xx], 10

``$ORGSTATUS[ ]`` 표현의 값은 명시적인 원본 응답코드(200, 404) 또는 응답코드 그룹(2xx, 3xx, 4xx, 5xx)으로 설정 가능하다. 
결합조건(&)을 지원하며, 부정조건(!)은 지원하지 않는다.



.. _caching-policy-customttl-cron:

TTL 만료시간 지정
---------------------

`Custom TTL`_ 을 확장하여 TTL 만료시간을 지정할 수 있다. ::

   # /svc/www.example.com/ttl.txt
   # {Match}, {TTL}, {minute hour} 순서로 표기한다.

   # 자정(00시 00분)에 TTL을 만료한다.
   /events/*, 86400, 0 0

   # 7시 38분에 TTL을 만료한다.
   /foo/bar, 86400, 38 7

   # 매 시간마다 TTL을 만료한다.
   /index.html, 86400, 0 *

   # 5분마다 TTL을 만료한다.
   /script/*.js, 86400, */5 *

   # 매 6시간마다 TTL을 만료한다.
   /image/ad.jpg, 86400, 0 */6
   

예제의 ``{TTL}`` 값이 86400인 이유는 TTL을 설정할 때 ``{TTL}`` 과 ``{minute hour}`` 중 작은 값을 선택하기 때문이다. ::

   /api/v1/*, 30
   /api/v2/*, 30, * *


예를 들어 위 설정의 경우 요청(=캐싱)시간을 기준으로 만료시간이 작은 값을 기준으로 설정된다.

=========== ============================ ===============
패턴         요청시간                     만료시간
=========== ============================ ===============
/api/v1/*    1:15:10                     1:15:40
/api/v1/*    1:15:40                     1:16:10
/api/v2/*    1:15:10                     1:15:40
/api/v2/*    1:15:40                     1:16:00
=========== ============================ ===============



.. note::
   
   설정을 변경해도 이미 캐싱된 객체의 TTL이 변경되지는 않는다.
   TTL은 객체가 초기화(=캐싱) 되는 시점에 고정되기 때문이다.
